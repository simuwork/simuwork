<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SimuWork - AI-Powered Job Simulation Platform</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            overflow: hidden;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0e1a;
        }

        .interactive-app {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 50%, #0f1729 100%);
            overflow: hidden;
        }

        /* Header */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 28px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .app-logo {
            font-size: 32px;
            filter: drop-shadow(0 0 8px rgba(102, 126, 234, 0.5));
        }

        .app-title-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .app-title {
            font-size: 22px;
            font-weight: 700;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.5px;
        }

        .live-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            font-size: 10px;
            font-weight: 700;
            border-radius: 12px;
            letter-spacing: 0.5px;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.4);
            animation: pulse 2s infinite;
            text-transform: uppercase;
        }

        .live-dot {
            width: 6px;
            height: 6px;
            background: white;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(0.98); }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .app-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.08) 100%);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.8);
            animation: blink 2s infinite;
        }

        /* Buttons */
        .btn-primary, .btn-secondary {
            padding: 10px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.6);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-large {
            font-size: 15px;
            padding: 12px 28px;
        }

        /* Main Layout */
        .app-main {
            flex: 1;
            display: grid;
            grid-template-columns: 300px 1fr 380px;
            gap: 16px;
            padding: 16px;
            overflow: hidden;
        }

        .left-column, .center-column, .right-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow: hidden;
        }

        .section {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            border-radius: 16px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .section:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.15);
        }

        .objectives-section { flex: 0 0 auto; max-height: 420px; }
        .terminal-section { flex: 1; min-height: 280px; }
        .code-section { flex: 1; }
        .messages-section { flex: 1; }

        /* Footer */
        .app-footer {
            padding: 12px 28px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer-text {
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
            font-weight: 500;
        }

        /* Loading Screen */
        .loading-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a1f35 100%);
            color: white;
        }

        .loading-spinner {
            width: 64px;
            height: 64px;
            border: 4px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-right-color: #764ba2;
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
            margin-bottom: 24px;
            box-shadow: 0 0 40px rgba(102, 126, 234, 0.4);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-screen p {
            font-size: 16px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.7);
        }

        /* Completion Overlay */
        .completion-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .completion-content {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.08) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 48px;
            max-width: 520px;
            text-align: center;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .completion-content h2 {
            margin: 0 0 16px 0;
            font-size: 36px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
        }

        .completion-content p {
            margin: 0 0 32px 0;
            font-size: 16px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
        }

        .completion-stats {
            display: flex;
            gap: 32px;
            justify-content: center;
            margin-bottom: 32px;
        }

        .stat {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-label {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Section Headers */
        .section-header {
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.02);
        }

        .section-title {
            font-size: 15px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: -0.3px;
        }

        .section-badge {
            font-size: 11px;
            font-weight: 600;
            padding: 4px 10px;
            background: rgba(102, 126, 234, 0.2);
            color: #a5b4fc;
            border-radius: 12px;
        }

        /* ObjectivesPanel */
        .objectives-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
        }

        .progress-container {
            margin-bottom: 20px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 8px;
            box-shadow: 0 0 16px rgba(102, 126, 234, 0.6);
        }

        .phase-info {
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .phase-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .phase-badge.orientation { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .phase-badge.investigation { background: rgba(251, 146, 60, 0.2); color: #fb923c; }
        .phase-badge.resolution { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .phase-badge.aftermath { background: rgba(34, 197, 94, 0.2); color: #22c55e; }

        .time-display {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 500;
        }

        .objectives-list {
            list-style: none;
        }

        .objective-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 14px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s;
        }

        .objective-item:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .objective-item.completed {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .objective-checkbox {
            width: 22px;
            height: 22px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 12px;
        }

        .objective-item.completed .objective-checkbox {
            background: #22c55e;
            border-color: #22c55e;
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.5);
        }

        .objective-text {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.6;
            font-weight: 500;
        }

        .objective-item.completed .objective-text {
            color: rgba(255, 255, 255, 0.5);
            text-decoration: line-through;
        }

        /* CodeEditor */
        .code-editor-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #1a1f2e;
        }

        .code-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: #21273a;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .file-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: #1a1f2e;
            border-radius: 8px;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .file-modified {
            color: #f59e0b;
            font-size: 16px;
            animation: pulse 2s infinite;
        }

        .run-tests-button {
            padding: 7px 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .run-tests-button:hover:not(:disabled) {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
        }

        .run-tests-button:disabled {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            box-shadow: none;
        }

        .code-editor-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .line-numbers {
            display: flex;
            flex-direction: column;
            background: #1a1f2e;
            padding: 16px 8px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            user-select: none;
        }

        .line-number {
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 20px;
            color: rgba(255, 255, 255, 0.3);
            text-align: right;
            min-width: 32px;
            padding-right: 12px;
        }

        .code-textarea {
            flex: 1;
            background: #1a1f2e;
            color: #e5e7eb;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 20px;
            padding: 16px;
            border: none;
            outline: none;
            resize: none;
            tab-size: 4;
        }

        .code-textarea::selection {
            background: rgba(102, 126, 234, 0.3);
        }

        /* TerminalOutput */
        .terminal-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #0d1117;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        }

        .terminal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: #161b22;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .terminal-dots {
            display: flex;
            gap: 6px;
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .dot-red { background: #ef4444; }
        .dot-yellow { background: #f59e0b; }
        .dot-green { background: #22c55e; }

        .terminal-title {
            flex: 1;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            text-align: center;
            font-weight: 600;
        }

        .terminal-clear {
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .terminal-clear:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
        }

        .terminal-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            color: #e5e7eb;
            font-size: 13px;
            line-height: 1.8;
        }

        .terminal-body::-webkit-scrollbar {
            width: 8px;
        }

        .terminal-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .terminal-body::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .terminal-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: rgba(255, 255, 255, 0.3);
        }

        .terminal-line {
            margin: 3px 0;
            padding-left: 4px;
            animation: fadeInLine 0.2s;
        }

        @keyframes fadeInLine {
            from { opacity: 0; transform: translateX(-5px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .terminal-command { color: #22c55e; font-weight: 600; }
        .terminal-info { color: rgba(255, 255, 255, 0.7); }
        .terminal-success { color: #22c55e; }
        .terminal-success-bold { color: #22c55e; font-weight: 700; }
        .terminal-error { color: #ef4444; }
        .terminal-error-detail { color: #ef4444; padding-left: 20px; font-size: 12px; opacity: 0.8; }
        .terminal-error-bold { color: #ef4444; font-weight: 700; }
        .terminal-running {
            color: #3b82f6;
            font-style: italic;
            animation: pulse 1.5s infinite;
        }

        /* AgentMessages */
        .messages-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        .messages-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .messages-body::-webkit-scrollbar {
            width: 8px;
        }

        .messages-body::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        .messages-body::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .message {
            padding: 14px 16px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
            animation: slideInMessage 0.3s;
        }

        @keyframes slideInMessage {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.alert {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }
        .message.warning {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        .message.hint {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        .message.approval {
            border-left-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
        }
        .message.escalation {
            border-left-color: #dc2626;
            background: rgba(220, 38, 38, 0.15);
            animation: shake 0.5s;
        }
        .message.user_message {
            border-left-color: #a855f7;
            background: rgba(168, 85, 247, 0.1);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .agent-avatar {
            font-size: 22px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .agent-name {
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            letter-spacing: -0.2px;
        }

        .message-timestamp {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.4);
            margin-left: auto;
            font-weight: 600;
        }

        .message-content {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.7;
            white-space: pre-wrap;
        }

        /* AI Input Boxes */
        .ai-input-container {
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-input-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-size: 12px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ai-input-icon {
            font-size: 14px;
        }

        .ai-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            min-height: 48px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .ai-input-wrapper:hover {
            border-color: rgba(102, 126, 234, 0.3);
            background: rgba(102, 126, 234, 0.08);
        }

        .ai-input-wrapper.active {
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(102, 126, 234, 0.1);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .ai-input-field {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            font-family: inherit;
        }

        .ai-input-field::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .ai-input-send {
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ai-input-wrapper.active .ai-input-send {
            opacity: 1;
        }

        .ai-input-send:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .ai-input-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Code Assistant specific styling */
        .code-assistant-input .ai-input-wrapper:hover {
            border-color: rgba(147, 51, 234, 0.3);
            background: rgba(147, 51, 234, 0.08);
        }

        .code-assistant-input .ai-input-wrapper.active {
            border-color: rgba(147, 51, 234, 0.5);
            background: rgba(147, 51, 234, 0.1);
            box-shadow: 0 0 0 3px rgba(147, 51, 234, 0.1);
        }

        .code-assistant-input .ai-input-send {
            background: linear-gradient(135deg, #9333ea 0%, #7c3aed 100%);
        }

        /* Team Chat specific styling */
        .team-chat-input .ai-input-wrapper:hover {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.08);
        }

        .team-chat-input .ai-input-wrapper.active {
            border-color: rgba(34, 197, 94, 0.5);
            background: rgba(34, 197, 94, 0.1);
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
        }

        .team-chat-input .ai-input-send {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .typing-cursor {
            display: inline-block;
            width: 2px;
            height: 16px;
            background: #667eea;
            margin-left: 2px;
            animation: blink 1s infinite;
            box-shadow: 0 0 8px #667eea;
        }

        /* TooltipGuide */
        .tooltip-guide {
            position: fixed;
            z-index: 3000;
            max-width: 420px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.1);
            animation: float 4s ease-in-out infinite, fadeIn 0.4s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .tooltip-agent-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
        }

        .tooltip-agent-icon {
            font-size: 28px;
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.3));
        }

        .tooltip-agent-name {
            font-size: 13px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .tooltip-title {
            font-size: 20px;
            font-weight: 800;
            color: white;
            margin-bottom: 10px;
            letter-spacing: -0.5px;
        }

        .tooltip-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.95);
            line-height: 1.7;
            margin-bottom: 14px;
        }

        .tooltip-highlight {
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            border-left: 3px solid rgba(255, 255, 255, 0.5);
            font-size: 13px;
            color: white;
            font-weight: 600;
            line-height: 1.5;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .app-main { grid-template-columns: 280px 1fr 360px; }
        }

        @media (max-width: 1200px) {
            .app-main {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
        }
    </style>
</head>
<body>
    <div id="root">
        <div class="loading-screen">
            <div class="loading-spinner"></div>
            <p>Initializing AI Agents...</p>
        </div>
    </div>

    <script>
        // ========================
        // EVENT BUS SYSTEM
        // ========================
        const EventTypes = {
            USER_CODE_CHANGE: 'user_code_change',
            USER_RUN_TESTS: 'user_run_tests',
            USER_ASK_QUESTION: 'user_ask_question',
            USER_DEPLOY: 'user_deploy',
            USER_VIEW_FILE: 'user_view_file',
            USER_DECISION: 'user_decision',
            AGENT_MESSAGE: 'agent_message',
            AGENT_CODE_REVIEW: 'agent_code_review',
            AGENT_HINT: 'agent_hint',
            AGENT_QUESTION: 'agent_question',
            SCENARIO_PHASE_CHANGE: 'scenario_phase_change',
            SCENARIO_OBJECTIVE_COMPLETE: 'scenario_objective_complete',
            SCENARIO_COMPLICATION: 'scenario_complication',
            SCENARIO_COMPLETE: 'scenario_complete',
            INCIDENT_CREATED: 'incident_created',
            INCIDENT_ESCALATED: 'incident_escalated',
            INCIDENT_RESOLVED: 'incident_resolved',
            TESTS_STARTED: 'tests_started',
            TESTS_PASSED: 'tests_passed',
            TESTS_FAILED: 'tests_failed',
            CODE_ERROR: 'code_error',
            CODE_WARNING: 'code_warning',
            CODE_QUALITY_CHECK: 'code_quality_check',
            TIME_TICK: 'time_tick',
            DEADLINE_APPROACHING: 'deadline_approaching',
            DEADLINE_MISSED: 'deadline_missed',
            STATE_UPDATED: 'state_updated',
            SYSTEM_READY: 'system_ready',
            SYSTEM_ERROR: 'system_error',
            NARRATION_SHOWN: 'narration_shown',
            NARRATION_HIDDEN: 'narration_hidden',
        };

        class EventBus {
            constructor() {
                this.subscriptions = {};
                this.eventHistory = [];
                this.subscriptionCounter = 0;
                this.maxHistorySize = 100;
            }

            subscribe(eventType, handler, subscriberId = 'anonymous') {
                if (!this.subscriptions[eventType]) {
                    this.subscriptions[eventType] = [];
                }

                const subscriptionId = `${subscriberId}_${this.subscriptionCounter++}`;
                this.subscriptions[eventType].push({
                    id: subscriptionId,
                    handler,
                    subscriberId,
                });

                return () => this.unsubscribe(eventType, subscriptionId);
            }

            unsubscribe(eventType, subscriptionId) {
                if (this.subscriptions[eventType]) {
                    this.subscriptions[eventType] = this.subscriptions[eventType].filter(
                        (sub) => sub.id !== subscriptionId
                    );
                }
            }

            publish(eventType, payload = {}, source = 'system') {
                const event = {
                    type: eventType,
                    payload,
                    source,
                    timestamp: Date.now(),
                };

                this.eventHistory.push(event);
                if (this.eventHistory.length > this.maxHistorySize) {
                    this.eventHistory.shift();
                }

                const subscribers = this.subscriptions[eventType] || [];
                const wildcardSubscribers = this.subscriptions['*'] || [];

                [...subscribers, ...wildcardSubscribers].forEach((sub) => {
                    try {
                        sub.handler(event);
                    } catch (error) {
                        console.error(`Error in event handler for ${eventType}:`, error);
                    }
                });
            }

            getRecentEvents(count = 10, eventType = null) {
                let events = this.eventHistory;
                if (eventType) {
                    events = events.filter((e) => e.type === eventType);
                }
                return events.slice(-count);
            }

            getEventsByType(eventType) {
                return this.eventHistory.filter((e) => e.type === eventType);
            }

            clear() {
                this.eventHistory = [];
            }
        }

        const eventBus = new EventBus();

        // ========================
        // WORLD STATE SYSTEM
        // ========================
        class WorldState {
            constructor() {
                this.state = this.getInitialState();
                this.listeners = [];
            }

            getInitialState() {
                return {
                    user: {
                        id: 'student_1',
                        skillLevels: {
                            debugging: 5,
                            systemDesign: 4,
                            testing: 4,
                            communication: 5,
                            problemSolving: 5,
                        },
                        reputation: 75,
                        completedScenarios: [],
                        learningStyle: 'hands-on',
                    },
                    world: {
                        company: {
                            name: 'PayFlow',
                            type: 'Fintech Startup',
                            techStack: ['Python', 'Django', 'PostgreSQL', 'React'],
                        },
                        incidents: [],
                        techDebt: [],
                        recentEvents: [],
                        timeElapsed: 0,
                    },
                    scenario: {
                        id: 'payment_api_debug',
                        type: 'debugging',
                        difficulty: 'intermediate',
                        phase: 'orientation',
                        timeElapsed: 0,
                        objectives: [
                            { id: 'obj_1', text: 'Understand the payment validation bug', completed: false },
                            { id: 'obj_2', text: 'Fix the validation logic', completed: false },
                            { id: 'obj_3', text: 'Ensure all tests pass', completed: false },
                        ],
                        codebase: {
                            currentFile: 'payments/utils.py',
                            hasChanges: false,
                            testsPass: false,
                        },
                    },
                    agents: {
                        senior_dev: {
                            mood: 'focused',
                            focus: 'code_review',
                            memory: [],
                            relationship: 50,
                            availability: 'available',
                        },
                        pm: {
                            mood: 'concerned',
                            focus: 'incident_management',
                            memory: [],
                            relationship: 50,
                            availability: 'available',
                            stress: 30,
                        },
                        junior_dev: {
                            mood: 'curious',
                            focus: 'learning',
                            memory: [],
                            relationship: 50,
                            availability: 'available',
                            askedForHelp: false,
                        },
                        incident: {
                            mood: 'monitoring',
                            focus: 'incident_tracking',
                            memory: [],
                            relationship: 50,
                            availability: 'active',
                            escalated: false,
                        },
                    },
                    ui: {
                        messages: [],
                        notifications: [],
                        codeEditorContent: '',
                        terminalOutput: [],
                        activePanel: 'code',
                        userTyping: false,
                        typingPreview: '',
                    },
                };
            }

            getState() {
                return JSON.parse(JSON.stringify(this.state));
            }

            updateState(updates, source = 'system') {
                this.state = this.deepMerge(this.state, updates);
                this.notifyListeners(this.state, updates);
            }

            deepMerge(target, source) {
                const result = { ...target };

                for (const key in source) {
                    if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                        result[key] = this.deepMerge(result[key] || {}, source[key]);
                    } else {
                        result[key] = source[key];
                    }
                }

                return result;
            }

            subscribe(listener) {
                this.listeners.push(listener);
                return () => {
                    this.listeners = this.listeners.filter(l => l !== listener);
                };
            }

            notifyListeners(newState, updates) {
                this.listeners.forEach(listener => {
                    try {
                        listener(newState, updates);
                    } catch (error) {
                        console.error('Error in state listener:', error);
                    }
                });
            }

            addMessage(message) {
                const newMessage = {
                    id: `msg_${Date.now()}_${Math.random()}`,
                    timestamp: Date.now(),
                    ...message,
                };

                const messages = [...this.state.ui.messages, newMessage];
                if (messages.length > 50) {
                    messages.shift();
                }

                this.updateState({
                    ui: { messages },
                });

                return newMessage.id;
            }

            completeObjective(objectiveId) {
                const objectives = this.state.scenario.objectives.map(obj =>
                    obj.id === objectiveId ? { ...obj, completed: true } : obj
                );

                this.updateState({
                    scenario: { objectives },
                });

                eventBus.publish(EventTypes.SCENARIO_OBJECTIVE_COMPLETE, {
                    objectiveId,
                    allComplete: objectives.every(obj => obj.completed),
                });
            }

            areObjectivesComplete() {
                return this.state.scenario.objectives.every(obj => obj.completed);
            }

            setScenarioPhase(phase) {
                this.updateState({
                    scenario: { phase },
                });

                eventBus.publish(EventTypes.SCENARIO_PHASE_CHANGE, { phase });
            }

            updateAgent(agentId, updates) {
                this.updateState({
                    agents: {
                        [agentId]: updates,
                    },
                });
            }

            incrementTime(seconds = 1) {
                const newTime = this.state.scenario.timeElapsed + seconds;
                this.updateState({
                    scenario: { timeElapsed: newTime },
                    world: { timeElapsed: newTime },
                });
            }

            updateUserSkill(skillName, delta) {
                const currentLevel = this.state.user.skillLevels[skillName] || 0;
                const newLevel = Math.max(0, Math.min(10, currentLevel + delta));

                this.updateState({
                    user: {
                        skillLevels: {
                            [skillName]: newLevel,
                        },
                    },
                });
            }

            recordUserAction(action) {
                const actions = [...(this.state.user.actionsHistory || []), {
                    ...action,
                    timestamp: Date.now(),
                }];

                this.updateState({
                    user: { actionsHistory: actions },
                });
            }

            reset() {
                const userData = this.state.user;
                this.state = this.getInitialState();
                this.state.user = userData;
                this.notifyListeners(this.state, {});
            }
        }

        const worldState = new WorldState();

        // ========================
        // GUIDE CONTROLLER
        // ========================
        class GuideController {
            constructor() {
                this.currentNarration = null;
                this.hideTimer = null;
                this.subscribers = [];
            }

            showNarration(narration) {
                if (this.hideTimer) {
                    clearTimeout(this.hideTimer);
                }

                this.currentNarration = narration;
                this.notifySubscribers();

                eventBus.publish(EventTypes.NARRATION_SHOWN, { narration });

                const duration = narration.duration || 6000;
                this.hideTimer = setTimeout(() => {
                    this.hideNarration();
                }, duration);
            }

            hideNarration() {
                if (this.hideTimer) {
                    clearTimeout(this.hideTimer);
                    this.hideTimer = null;
                }

                this.currentNarration = null;
                this.notifySubscribers();

                eventBus.publish(EventTypes.NARRATION_HIDDEN);
            }

            getCurrentNarration() {
                return this.currentNarration;
            }

            subscribe(callback) {
                this.subscribers.push(callback);
                return () => {
                    this.subscribers = this.subscribers.filter(cb => cb !== callback);
                };
            }

            notifySubscribers() {
                this.subscribers.forEach(callback => {
                    try {
                        callback(this.currentNarration);
                    } catch (error) {
                        console.error('Error in guide subscriber:', error);
                    }
                });
            }

            reset() {
                if (this.hideTimer) {
                    clearTimeout(this.hideTimer);
                }
                this.currentNarration = null;
                this.hideTimer = null;
                this.notifySubscribers();
            }
        }

        const guideController = new GuideController();

        // ========================
        // BASE AGENT CLASS
        // ========================
        class BaseAgent {
            constructor(config) {
                this.id = config.id;
                this.role = config.role;
                this.personality = config.personality || {};
                this.subscriptions = [];
                this.memory = [];
                this.config = {
                    responseDelay: config.responseDelay || 1000,
                    proactivityChance: config.proactivityChance || 0.1,
                    verbosity: config.verbosity || 'normal',
                };
                this.messageCount = 0;
                this.lastActionTime = Date.now();
            }

            subscribeToEvents(eventTypes) {
                eventTypes.forEach(eventType => {
                    const unsubscribe = eventBus.subscribe(
                        eventType,
                        (event) => this.handleEvent(event),
                        this.id
                    );
                    this.subscriptions.push(unsubscribe);
                });
            }

            handleEvent(event) {
                this.remember(event);

                if (this.shouldReact(event)) {
                    this.react(event);
                }
            }

            remember(event) {
                this.memory.push(event);
                if (this.memory.length > 20) {
                    this.memory.shift();
                }
            }

            shouldReact(event) {
                return true;
            }

            react(event) {
                // Override in subclasses
            }

            sendMessage(content, metadata = {}) {
                setTimeout(() => {
                    worldState.addMessage({
                        agentId: this.id,
                        agentRole: this.role,
                        content: this.generateResponse(content, metadata),
                        type: metadata.type || 'response',
                        severity: metadata.severity || 'medium',
                        ...metadata,
                    });

                    this.messageCount++;
                    this.lastActionTime = Date.now();
                }, this.config.responseDelay);
            }

            giveHint(hint, severity = 'medium') {
                this.sendMessage(hint, {
                    type: 'hint',
                    severity,
                });

                eventBus.publish(EventTypes.AGENT_HINT, {
                    agentId: this.id,
                    hint,
                    severity,
                });
            }

            askQuestion(question, context = {}) {
                this.sendMessage(question, {
                    type: 'question',
                    ...context,
                });

                eventBus.publish(EventTypes.AGENT_QUESTION, {
                    agentId: this.id,
                    question,
                    context,
                });
            }

            reviewCode(code, feedback) {
                this.sendMessage(feedback, {
                    type: 'code_review',
                });

                eventBus.publish(EventTypes.AGENT_CODE_REVIEW, {
                    agentId: this.id,
                    code,
                    feedback,
                });
            }

            generateResponse(baseMessage, context) {
                return baseMessage;
            }

            observeState() {
                return worldState.getState();
            }

            updateAgentState(updates) {
                worldState.updateAgent(this.id, updates);
            }

            getMetrics() {
                return {
                    messageCount: this.messageCount,
                    memorySize: this.memory.length,
                    lastActionTime: this.lastActionTime,
                };
            }

            destroy() {
                this.subscriptions.forEach(unsubscribe => unsubscribe());
                this.subscriptions = [];
            }
        }

        // ========================
        // AGENT IMPLEMENTATIONS
        // ========================

        class SeniorDevAgent extends BaseAgent {
            constructor() {
                super({
                    id: 'senior_dev',
                    role: 'Senior Engineer',
                    personality: { style: 'socratic', traits: ['patient', 'thorough', 'cryptic'] },
                    responseDelay: 2000,
                });

                this.testFailureCount = 0;
                this.subscribeToEvents([
                    EventTypes.USER_CODE_CHANGE,
                    EventTypes.USER_ASK_QUESTION,
                    EventTypes.TESTS_FAILED,
                    EventTypes.SCENARIO_PHASE_CHANGE,
                    'director_trigger_agent',
                ]);
            }

            shouldReact(event) {
                if (event.type === 'director_trigger_agent' && event.payload.agentId === this.id) {
                    return true;
                }
                if (event.type === EventTypes.USER_CODE_CHANGE) {
                    const code = event.payload.code;
                    const issues = this.analyzeCode(code);
                    return issues.length > 0;
                }
                return event.type === EventTypes.USER_ASK_QUESTION ||
                       event.type === EventTypes.TESTS_FAILED ||
                       event.type === EventTypes.SCENARIO_PHASE_CHANGE;
            }

            react(event) {
                if (event.type === 'director_trigger_agent') {
                    this.handleDirectorTrigger(event.payload);
                } else if (event.type === EventTypes.USER_CODE_CHANGE) {
                    this.onCodeChange(event.payload);
                } else if (event.type === EventTypes.USER_ASK_QUESTION) {
                    this.onUserQuestion(event.payload);
                } else if (event.type === EventTypes.TESTS_FAILED) {
                    this.onTestsFailed(event.payload);
                } else if (event.type === EventTypes.SCENARIO_PHASE_CHANGE) {
                    this.onPhaseChange(event.payload);
                }
            }

            handleDirectorTrigger(payload) {
                const actions = {
                    'initial_guidance': () => this.provideInitialGuidance(),
                    'auto': () => this.provideInitialGuidance(),
                };

                const action = actions[payload.action];
                if (action) {
                    setTimeout(() => action(), this.config.responseDelay);
                }
            }

            provideInitialGuidance() {
                this.sendMessage(
                    "I see we have a P2 incident with payment validation. Let's start by examining the process_payment function. What does the validation logic look like?",
                    { type: 'response' }
                );
            }

            analyzeCode(code) {
                const issues = [];

                if (code.includes('amount > 0') && !code.includes('amount <= 0')) {
                    issues.push({
                        severity: 'critical',
                        message: 'The condition `amount > 0` won\'t catch zero-dollar transactions. Consider using `amount <= 0` instead.',
                    });
                }

                if (!code.includes('raise')) {
                    issues.push({
                        severity: 'warning',
                        message: 'Missing explicit error handling. Consider raising an exception for invalid amounts.',
                    });
                }

                return issues;
            }

            onCodeChange(payload) {
                const issues = this.analyzeCode(payload.code);
                if (issues.length > 0) {
                    const criticalIssues = issues.filter(i => i.severity === 'critical');
                    if (criticalIssues.length > 0) {
                        this.sendMessage(criticalIssues[0].message, {
                            type: 'warning',
                            severity: 'high',
                        });
                    }
                }
            }

            onUserQuestion(payload) {
                const question = payload.question.toLowerCase();

                if (question.includes('zero') || question.includes('0')) {
                    this.sendMessage(
                        "Good catch! Zero-dollar amounts are tricky. They're often used for authorization checks in payment systems, but our current validation lets them slip through silently.",
                        { type: 'response' }
                    );
                } else if (question.includes('test') || question.includes('validation')) {
                    this.sendMessage(
                        "For validation bugs like this, I always recommend writing a test case first. What values should we be checking? Positive, zero, and negative amounts.",
                        { type: 'response' }
                    );
                }
            }

            onTestsFailed(payload) {
                this.testFailureCount++;

                if (this.testFailureCount === 1) {
                    this.sendMessage(
                        "Tests failed, but that's part of the process. Review the error messages carefully - they'll guide you.",
                        { type: 'response' }
                    );
                } else if (this.testFailureCount === 2) {
                    this.giveHint(
                        "Hint: Look at the comparison operator in your validation. What's the difference between > and >=?",
                        'medium'
                    );
                } else if (this.testFailureCount >= 3) {
                    this.giveHint(
                        "The fix is to change `amount > 0` to `amount <= 0` for the error condition.",
                        'high'
                    );
                }
            }

            onPhaseChange(payload) {
                if (payload.phase === 'resolution') {
                    this.sendMessage(
                        "Now that you understand the bug, let's fix it. Remember to handle both zero and negative amounts.",
                        { type: 'response' }
                    );
                }
            }
        }

        class ProductManagerAgent extends BaseAgent {
            constructor() {
                super({
                    id: 'pm',
                    role: 'Product Manager',
                    personality: { style: 'business', traits: ['focused', 'deadline-conscious', 'empathetic'] },
                    responseDelay: 1500,
                });

                this.checkInInterval = null;
                this.subscribeToEvents([
                    EventTypes.SCENARIO_PHASE_CHANGE,
                    EventTypes.TESTS_PASSED,
                    EventTypes.INCIDENT_ESCALATED,
                    'director_trigger_agent',
                ]);
            }

            shouldReact(event) {
                if (event.type === 'director_trigger_agent' && event.payload.agentId === this.id) {
                    return true;
                }
                return true;
            }

            react(event) {
                if (event.type === 'director_trigger_agent') {
                    this.handleDirectorTrigger(event.payload);
                } else if (event.type === EventTypes.SCENARIO_PHASE_CHANGE) {
                    this.onPhaseChange(event.payload);
                } else if (event.type === EventTypes.TESTS_PASSED) {
                    this.onTestsPassed(event.payload);
                } else if (event.type === EventTypes.INCIDENT_ESCALATED) {
                    this.onIncidentEscalated(event.payload);
                }
            }

            handleDirectorTrigger(payload) {
                const actions = {
                    'phase_change_investigation': () => this.sendInitialIncident(),
                    'check_progress': () => this.checkProgress(),
                };

                const action = actions[payload.action];
                if (action) {
                    setTimeout(() => action(), this.config.responseDelay);
                }
            }

            sendInitialIncident() {
                worldState.setScenarioPhase('investigation');
                this.sendMessage(
                    "Team - we have a P2 incident. Payment validation is failing for some transactions. This is affecting 127 users. Can someone investigate ASAP?",
                    { type: 'alert', severity: 'high' }
                );

                this.updateAgentState({ stress: 40 });
            }

            checkProgress() {
                this.sendMessage(
                    "Quick check - how are we progressing on the payment validation fix? Any blockers I should know about?",
                    { type: 'response' }
                );
            }

            onPhaseChange(payload) {
                if (payload.phase === 'resolution') {
                    this.sendMessage(
                        "Good, we're moving to resolution. Let me know once tests pass and we can coordinate the deployment.",
                        { type: 'response' }
                    );
                }
            }

            onTestsPassed(payload) {
                this.sendMessage(
                    "Excellent! All tests passing. This is exactly what I wanted to see. Can you provide a brief summary for the incident report?",
                    { type: 'approval', severity: 'high' }
                );

                this.updateAgentState({ stress: 10 });

                const state = worldState.getState();
                const relationship = state.agents.pm.relationship;
                worldState.updateAgent('pm', { relationship: relationship + 15 });
            }

            onIncidentEscalated(payload) {
                this.sendMessage(
                    "This just escalated to P1! We now have 254 affected users. We need this fixed ASAP.",
                    { type: 'escalation', severity: 'critical' }
                );

                this.updateAgentState({ stress: 80 });
            }
        }

        class JuniorDevAgent extends BaseAgent {
            constructor() {
                super({
                    id: 'junior_dev',
                    role: 'Junior Developer',
                    personality: { style: 'friendly', traits: ['curious', 'eager', 'learning'] },
                    responseDelay: 2500,
                });

                this.askedForHelp = false;
                this.subscribeToEvents([
                    EventTypes.SCENARIO_PHASE_CHANGE,
                    EventTypes.USER_DECISION,
                    EventTypes.TESTS_PASSED,
                    'director_trigger_agent',
                ]);
            }

            shouldReact(event) {
                if (event.type === 'director_trigger_agent' && event.payload.agentId === this.id) {
                    return true;
                }
                return true;
            }

            react(event) {
                if (event.type === 'director_trigger_agent') {
                    this.handleDirectorTrigger(event.payload);
                } else if (event.type === EventTypes.SCENARIO_PHASE_CHANGE) {
                    this.onPhaseChange(event.payload);
                } else if (event.type === EventTypes.USER_DECISION) {
                    this.onUserDecision(event.payload);
                } else if (event.type === EventTypes.TESTS_PASSED) {
                    this.onTestsPassed(event.payload);
                }
            }

            handleDirectorTrigger(payload) {
                const actions = {
                    'teammate_help_request': () => this.requestHelp(),
                };

                const action = actions[payload.action];
                if (action) {
                    setTimeout(() => action(), this.config.responseDelay);
                }
            }

            requestHelp() {
                if (!this.askedForHelp) {
                    this.askedForHelp = true;
                    this.sendMessage(
                        "Hey! I'm seeing similar errors in the refund API. Are they related to the payment validation bug you're fixing?",
                        { type: 'question' }
                    );
                }
            }

            onPhaseChange(payload) {
                if (payload.phase === 'investigation') {
                    this.sendMessage(
                        "Interesting - I noticed the validation logic checks for positive amounts. Wonder if that's related?",
                        { type: 'response' }
                    );
                }
            }

            onUserDecision(payload) {
                if (payload.decisionId === 'help_junior_dev') {
                    if (payload.decision === 'explain_likely_related') {
                        this.sendMessage(
                            "That makes sense! So if we fix the payment validation, it should fix the refund API too. Thanks for explaining!",
                            { type: 'response' }
                        );

                        worldState.updateUserSkill('communication', 0.5);
                        const state = worldState.getState();
                        worldState.updateAgent('junior_dev', {
                            relationship: state.agents.junior_dev.relationship + 15,
                        });
                    }
                }
            }

            onTestsPassed(payload) {
                if (this.askedForHelp) {
                    this.sendMessage(
                        "Just tested your fix against the refund API - working perfectly! Thanks for explaining the connection earlier.",
                        { type: 'approval' }
                    );
                }
            }
        }

        class IncidentAgent extends BaseAgent {
            constructor() {
                super({
                    id: 'incident',
                    role: 'Incident System',
                    personality: { style: 'automated', traits: ['objective', 'monitoring'] },
                    responseDelay: 500,
                });

                this.affectedUsers = 127;
                this.escalated = false;
                this.subscribeToEvents([
                    EventTypes.TESTS_PASSED,
                    EventTypes.SCENARIO_PHASE_CHANGE,
                    EventTypes.TIME_TICK,
                    'director_trigger_agent',
                ]);
            }

            shouldReact(event) {
                if (event.type === 'director_trigger_agent' && event.payload.agentId === this.id) {
                    return true;
                }
                return true;
            }

            react(event) {
                if (event.type === 'director_trigger_agent') {
                    this.handleDirectorTrigger(event.payload);
                } else if (event.type === EventTypes.TESTS_PASSED) {
                    this.onTestsPassed(event.payload);
                } else if (event.type === EventTypes.SCENARIO_PHASE_CHANGE) {
                    this.onPhaseChange(event.payload);
                }
            }

            handleDirectorTrigger(payload) {
                const actions = {
                    'auto': () => this.sendInitialAlert(),
                };

                const action = actions[payload.action];
                if (action) {
                    setTimeout(() => action(), this.config.responseDelay);
                }
            }

            sendInitialAlert() {
                this.sendMessage(
                    ` INCIDENT ALERT - P2
Severity: High
Affected Users: ${this.affectedUsers}
Service: Payment Validation API

Error Pattern:
- Zero-dollar payment authorizations passing validation
- Expected: Reject invalid amounts
- Actual: Processing $0 transactions

Stack Trace:
  File "payments/utils.py", line 127, in process_payment
    if amount > 0:
      return "Success"

Investigation Required`,
                    { type: 'alert', severity: 'high' }
                );

                eventBus.publish(EventTypes.INCIDENT_CREATED, {
                    severity: 'P2',
                    affectedUsers: this.affectedUsers,
                });

                worldState.completeObjective('obj_1');
            }

            onTestsPassed(payload) {
                setTimeout(() => {
                    this.sendMessage(
                        ` VALIDATION COMPLETE

All 12 tests passed:
 test_positive_amount_succeeds
 test_zero_amount_rejected
 test_negative_amount_rejected

Fix confirmed. Ready for deployment.`,
                        { type: 'approval', severity: 'high' }
                    );
                }, 1000);

                setTimeout(() => {
                    this.sendMessage(
                        ` All tests passed!

 INCIDENT CLOSED
Total Duration: ~2 minutes
Resolution: Payment validation logic updated
Credential Awarded: Backend Debugging - Payments API`,
                        { type: 'approval', severity: 'high' }
                    );

                    eventBus.publish(EventTypes.INCIDENT_RESOLVED);
                }, 3000);
            }

            onPhaseChange(payload) {
                if (payload.phase === 'resolution') {
                    this.sendMessage(
                        ` STATUS UPDATE
Phase: Resolution
Affected Users: ${this.affectedUsers}
Time Elapsed: ${Math.floor(worldState.getState().scenario.timeElapsed / 60)}m

Developer working on fix...`,
                        { type: 'response' }
                    );
                }
            }
        }

        // Code Assistant Agent - AI Pair Programming Assistant
        class CodeAssistantAgent extends BaseAgent {
            constructor() {
                super({
                    id: 'code_assistant',
                    role: 'Code Assistant AI',
                    personality: { style: 'helpful', traits: ['precise', 'educational', 'encouraging'] },
                    responseDelay: 1500,
                });

                this.subscribeToEvents([
                    'USER_CODE_QUESTION',
                    EventTypes.USER_CODE_CHANGE,
                ]);
            }

            shouldReact(event) {
                return event.type === 'USER_CODE_QUESTION' ||
                       (event.type === EventTypes.USER_CODE_CHANGE && this.detectCodeIssue(event.payload.code));
            }

            react(event) {
                if (event.type === 'USER_CODE_QUESTION') {
                    this.onUserCodeQuestion(event.payload);
                } else if (event.type === EventTypes.USER_CODE_CHANGE) {
                    this.onCodeChange(event.payload);
                }
            }

            onUserCodeQuestion(payload) {
                const question = payload.question.toLowerCase();
                const code = worldState.getState().ui.codeEditorContent || '';

                let response = '';

                // Analyze question context
                if (question.includes('syntax') || question.includes('how to write')) {
                    response = this.provideSyntaxHelp(question, code);
                } else if (question.includes('bug') || question.includes('error') || question.includes('wrong')) {
                    response = this.debugHelp(question, code);
                } else if (question.includes('test') || question.includes('validate')) {
                    response = this.testingHelp(question, code);
                } else if (question.includes('improve') || question.includes('better') || question.includes('refactor')) {
                    response = this.improvementHelp(question, code);
                } else {
                    response = this.generalHelp(question, code);
                }

                setTimeout(() => {
                    this.sendMessage(response, { type: 'code_assistance', agentIcon: '' });
                }, this.config.responseDelay);
            }

            provideSyntaxHelp(question, code) {
                return `Let me help with the syntax! In Python:

 Exception classes inherit from built-in exceptions:
  \`class MyError(ValueError):\`

 Condition checks use comparison operators:
  \`if amount <= 0:\` checks if amount is 0 or negative

 Raise exceptions with descriptive messages:
  \`raise PaymentValidationError("message")\`

Try writing it out and I'll review it for you!`;
            }

            debugHelp(question, code) {
                const issues = [];

                if (code.includes('amount > 0') && !code.includes('amount <= 0')) {
                    issues.push(' The condition `amount > 0` doesn\'t catch zero values');
                    issues.push(' Consider: What happens when amount is exactly 0?');
                }

                if (!code.includes('raise') && code.includes('else:')) {
                    issues.push(' You might want to raise an exception for invalid amounts');
                }

                if (issues.length > 0) {
                    return `I found some potential issues:\n\n${issues.join('\n')}\n\nWant to walk through the logic together?`;
                }

                return `The code structure looks good! The validation logic should:\n1. Check if amount is valid (> 0)\n2. Raise an exception if invalid\n3. Process payment if valid\n\nDoes your current code do all three?`;
            }

            testingHelp(question, code) {
                return `For this payment validation, you'll want to test:

 Positive amounts  Should succeed
 Zero amounts  Should raise error
 Negative amounts  Should raise error

The current test suite checks all three cases. Run your tests to see if your code handles them correctly!`;
            }

            improvementHelp(question, code) {
                return `Great mindset! Here are some improvement ideas:

1. **Clear error messages**: Use descriptive exception messages
2. **Proper exception types**: Create custom exceptions like \`PaymentValidationError\`
3. **Edge cases**: Make sure to handle 0, negative, and boundary values

Your current goal is to fix the validation bug first, then we can refine!`;
            }

            generalHelp(question, code) {
                return `I'm here to help with your code! I can assist with:

 Syntax and Python patterns
 Debugging and finding issues
 Testing strategies
 Code improvements

What specific part of the payment validation would you like to work on?`;
            }

            detectCodeIssue(code) {
                // Proactively detect critical issues
                return false; // Disabled during demo mode
            }

            onCodeChange(payload) {
                // Reserved for proactive code analysis
                // Currently disabled during scripted demo
            }
        }

        // ========================
        // AGENT ORCHESTRATOR
        // ========================
        class AgentOrchestrator {
            constructor() {
                this.agents = {};
                this.initialized = false;
                this.timerId = null;
            }

            initialize() {
                console.log('[AgentOrchestrator] Initializing agents...');

                this.agents = {
                    senior_dev: new SeniorDevAgent(),
                    pm: new ProductManagerAgent(),
                    junior_dev: new JuniorDevAgent(),
                    incident: new IncidentAgent(),
                    code_assistant: new CodeAssistantAgent(),
                };

                worldState.subscribe(() => {
                    // React to state changes if needed
                });

                // Start time ticker
                this.startTimeTicker();

                this.initialized = true;
                console.log('[AgentOrchestrator] Agents initialized');

                eventBus.publish(EventTypes.SYSTEM_READY);
            }

            startTimeTicker() {
                this.timerId = setInterval(() => {
                    worldState.incrementTime(1);
                    eventBus.publish(EventTypes.TIME_TICK, {
                        elapsed: worldState.getState().scenario.timeElapsed,
                    });
                }, 1000);
            }

            getAgent(agentId) {
                return this.agents[agentId];
            }

            getAllAgents() {
                return this.agents;
            }

            restart() {
                this.destroy();
                worldState.reset();
                this.initialize();
            }

            destroy() {
                if (this.timerId) {
                    clearInterval(this.timerId);
                }

                Object.values(this.agents).forEach(agent => agent.destroy());
                this.agents = {};
                this.initialized = false;
            }
        }

        const agentOrchestrator = new AgentOrchestrator();

        // Continue in next script block...
    </script>

    <script>
        // ========================
        // DEMO SCRIPT
        // ========================
        const demoScript = [
            {
                time: 0,
                type: 'show_narration',
                narration: {
                    agent: 'SimuWork AI',
                    agentIcon: '',
                    title: 'Welcome to SimuWork',
                    description: 'Watch as multiple AI agents work together to mentor you through a real Payment API debugging challenge.',
                    position: 'top-center',
                    color: 'blue',
                    duration: 5000,
                },
            },
            {
                time: 3,
                type: 'agent_message',
                agentId: 'incident',
                trigger: 'auto',
            },
            {
                time: 4,
                type: 'show_narration',
                narration: {
                    agent: 'Incident Agent',
                    agentIcon: '',
                    description: 'The Incident Agent detects a critical bug and alerts the team automatically.',
                    position: 'right',
                    color: 'orange',
                    duration: 5000,
                },
            },
            {
                time: 8,
                type: 'agent_message',
                agentId: 'pm',
                trigger: 'phase_change_investigation',
            },
            {
                time: 12,
                type: 'agent_message',
                agentId: 'senior_dev',
                trigger: 'initial_guidance',
            },
            {
                time: 13,
                type: 'show_narration',
                narration: {
                    agent: 'Senior Engineer AI',
                    agentIcon: '',
                    description: 'The Senior Engineer AI provides guidance and helps you investigate the code.',
                    position: 'right',
                    color: 'blue',
                    duration: 5000,
                },
            },
            {
                time: 18,
                type: 'user_message',
                content: "What's causing the payment validation failures?",
                typingDuration: 2000,
            },
            {
                time: 19,
                type: 'show_narration',
                narration: {
                    agent: 'Student Interaction',
                    agentIcon: '',
                    description: 'Students can ask questions and get instant, personalized feedback from AI mentors.',
                    position: 'bottom',
                    color: 'green',
                    duration: 5000,
                },
            },
            {
                time: 21,
                type: 'agent_message',
                agentId: 'senior_dev',
                message: "Good question. Take a look at the process_payment function - specifically the validation logic. What condition is being checked before we process the payment?",
            },
            {
                time: 28,
                type: 'user_message',
                content: "I see it checks if amount > 0. Is that the bug?",
                typingDuration: 2000,
            },
            {
                time: 31,
                type: 'agent_message',
                agentId: 'senior_dev',
                message: "Exactly! Think about it - if amount is 0, does that condition catch it? What happens with zero-dollar authorizations?",
            },
            {
                time: 36,
                type: 'user_message',
                content: "Oh! Zero passes through because 0 is not > 0, but it's also not raising an error.",
                typingDuration: 2500,
            },
            {
                time: 40,
                type: 'agent_message',
                agentId: 'senior_dev',
                message: "Bingo! You've found the root cause. Zero-dollar amounts slip through the validation. Now, how would you fix this?",
            },
            {
                time: 45,
                type: 'agent_message',
                agentId: 'junior_dev',
                trigger: 'teammate_help_request',
            },
            {
                time: 50,
                type: 'user_decision_auto',
                decisionId: 'help_junior_dev',
                choice: 'explain_likely_related',
            },
            {
                time: 58,
                type: 'agent_message',
                agentId: 'pm',
                trigger: 'check_progress',
            },
            {
                time: 62,
                type: 'user_message',
                content: "Found the bug - the validation isn't catching zero amounts. Working on the fix now.",
                typingDuration: 2500,
            },
            {
                time: 66,
                type: 'agent_message',
                agentId: 'pm',
                message: "Great work! Let me know once you have tests passing and I'll coordinate the deployment.",
            },
            {
                time: 72,
                type: 'user_message',
                content: "How should I structure the fix? Should I create a custom exception?",
                typingDuration: 2500,
            },
            {
                time: 76,
                type: 'agent_message',
                agentId: 'senior_dev',
                message: "Good thinking! Yes, create a PaymentValidationError exception class. Then change the condition to `if amount <= 0:` and raise that exception. This makes the error explicit and easier to handle upstream.",
            },
            {
                time: 82,
                type: 'code_change',
                code: `class PaymentValidationError(ValueError):
    pass


def process_payment(amount):
    if amount <= 0:
        raise PaymentValidationError("Amount must be greater than zero")
    # Simulate gateway dispatch
    return "Success"`,
            },
            {
                time: 83,
                type: 'show_narration',
                narration: {
                    agent: 'Code Editor',
                    agentIcon: '',
                    description: 'The student writes code with real-time AI analysis checking for bugs and security issues.',
                    position: 'center',
                    color: 'purple',
                    duration: 5000,
                },
            },
            {
                time: 85,
                type: 'agent_message',
                agentId: 'senior_dev',
                message: "Looking good! The logic is now correct - rejecting zero and negative amounts. Run the tests to validate.",
            },
            {
                time: 90,
                type: 'run_tests',
            },
            {
                time: 91,
                type: 'show_narration',
                narration: {
                    agent: 'Testing Agent',
                    agentIcon: '',
                    description: 'The Testing Agent automatically runs tests and provides instant feedback on code quality.',
                    position: 'left',
                    color: 'green',
                    duration: 5000,
                },
            },
            {
                time: 93,
                type: 'agent_message',
                agentId: 'senior_dev',
                message: "Perfect! All 12 tests passing. The fix correctly handles positive, zero, and negative amounts. Nice work!",
            },
            {
                time: 98,
                type: 'agent_message',
                agentId: 'pm',
                message: "Tests passing - excellent! That's what I like to see. I'm updating the incident status to resolved.",
            },
            {
                time: 102,
                type: 'agent_message',
                agentId: 'junior_dev',
                message: "Just tested your fix against the refund API - working perfectly! Thanks for explaining the connection earlier.",
            },
            {
                time: 108,
                type: 'agent_message',
                agentId: 'incident',
                message: " All tests passed!\n\n INCIDENT CLOSED\nTotal Duration: ~2 minutes\nResolution: Payment validation logic updated\nCredential Awarded: Backend Debugging - Payments API",
            },
            {
                time: 109,
                type: 'show_narration',
                narration: {
                    agent: 'SimuWork',
                    agentIcon: '',
                    title: 'Challenge Complete!',
                    description: 'Students earn verified credentials proving they successfully completed real-world company challenges.',
                    position: 'top-center',
                    color: 'green',
                    highlight: 'Employer-recognized credentials that stand out on resumes',
                    duration: 6000,
                },
            },
            {
                time: 112,
                type: 'scenario_complete',
            },
        ];

        // ========================
        // DEMO CONTROLLER
        // ========================
        class DemoController {
            constructor() {
                this.isPlaying = false;
                this.currentIndex = 0;
                this.startTime = null;
                this.timers = [];
            }

            start() {
                if (this.isPlaying) return;

                console.log('[DemoController] Starting choreographed demo...');
                this.isPlaying = true;
                this.currentIndex = 0;
                this.startTime = Date.now();

                this.scheduleActions();
            }

            scheduleActions() {
                demoScript.forEach((action, index) => {
                    const delay = action.time * 1000;
                    const timer = setTimeout(() => {
                        this.executeAction(action, index);
                    }, delay);
                    this.timers.push(timer);
                });
            }

            executeAction(action, index) {
                console.log(`[DemoController] Executing action ${index}:`, action.type);
                this.currentIndex = index;

                switch (action.type) {
                    case 'show_narration':
                        this.showNarration(action.narration);
                        break;
                    case 'user_message':
                        this.showTypingMessage(action.content, action.typingDuration || 2000);
                        break;
                    case 'agent_message':
                        this.triggerAgentMessage(action);
                        break;
                    case 'code_change':
                        this.applyCodeChange(action.code);
                        break;
                    case 'run_tests':
                        this.runTests();
                        break;
                    case 'user_decision_auto':
                        this.makeDecision(action.decisionId, action.choice);
                        break;
                    case 'scenario_complete':
                        this.completeScenario();
                        break;
                }
            }

            showNarration(narration) {
                guideController.showNarration(narration);
            }

            showTypingMessage(content, duration) {
                worldState.updateState({
                    ui: { userTyping: true },
                });

                let currentText = '';
                const chars = content.split('');
                const charDelay = duration / chars.length;

                chars.forEach((char, i) => {
                    setTimeout(() => {
                        currentText += char;
                        worldState.updateState({
                            ui: { typingPreview: currentText },
                        });
                    }, charDelay * i);
                });

                setTimeout(() => {
                    worldState.updateState({
                        ui: {
                            userTyping: false,
                            typingPreview: '',
                        },
                    });

                    worldState.addMessage({
                        agentId: 'user',
                        agentRole: 'You',
                        content,
                        type: 'user_message',
                    });

                    if (content.includes('?')) {
                        eventBus.publish(EventTypes.USER_ASK_QUESTION, {
                            question: content,
                            timestamp: Date.now(),
                        }, 'user');
                    }
                }, duration);
            }

            triggerAgentMessage(action) {
                if (action.trigger) {
                    eventBus.publish('director_trigger_agent', {
                        agentId: action.agentId,
                        action: action.trigger,
                    });
                } else if (action.message) {
                    worldState.addMessage({
                        agentId: action.agentId,
                        agentRole: this.getAgentRole(action.agentId),
                        content: action.message,
                        type: 'response',
                    });
                }
            }

            applyCodeChange(code) {
                worldState.updateState({
                    ui: { codeEditorContent: code },
                    scenario: {
                        codebase: {
                            currentFile: 'payments/utils.py',
                            hasChanges: true,
                        },
                    },
                });

                eventBus.publish(EventTypes.USER_CODE_CHANGE, {
                    code,
                    hasChanges: true,
                    timestamp: Date.now(),
                }, 'user');
            }

            runTests() {
                eventBus.publish(EventTypes.USER_RUN_TESTS, {
                    code: worldState.getState().ui.codeEditorContent,
                    timestamp: Date.now(),
                }, 'user');

                // Simulate test success
                setTimeout(() => {
                    eventBus.publish(EventTypes.TESTS_PASSED, {
                        code: worldState.getState().ui.codeEditorContent,
                        testCount: 12,
                    }, 'system');

                    worldState.completeObjective('obj_2');
                    worldState.completeObjective('obj_3');
                }, 1500);
            }

            makeDecision(decisionId, choice) {
                eventBus.publish(EventTypes.USER_DECISION, {
                    decisionId,
                    decision: choice,
                    timestamp: Date.now(),
                }, 'user');
            }

            completeScenario() {
                eventBus.publish(EventTypes.SCENARIO_COMPLETE, {
                    timeElapsed: worldState.getState().scenario.timeElapsed,
                    objectivesComplete: worldState.areObjectivesComplete(),
                });
            }

            getAgentRole(agentId) {
                const roles = {
                    senior_dev: 'Senior Engineer',
                    pm: 'Product Manager',
                    junior_dev: 'Junior Developer',
                    incident: 'Incident System',
                };
                return roles[agentId] || 'System';
            }

            stop() {
                console.log('[DemoController] Stopping demo...');
                this.timers.forEach(timer => clearTimeout(timer));
                this.timers = [];
                this.isPlaying = false;
                this.currentIndex = 0;
                this.startTime = null;
            }
        }

        const demoController = new DemoController();

        // Continue with UI Components...
    </script>

    <script>
        // ========================
        // UI COMPONENTS
        // ========================

        // Utility function to format time
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        // Initial code for the editor
        const initialCode = `def process_payment(amount):
    if amount > 0:
        return "Success"
    else:
        raise ValueError("Invalid amount")`;

        // Track last rendered message count to avoid re-rendering
        let lastRenderedMessageCount = 0;

        // Track last rendered narration to avoid flickering
        let lastRenderedNarration = null;

        // Component: ObjectivesPanel
        function renderObjectivesPanel() {
            const container = document.getElementById('objectives-panel');
            if (!container) return;

            const state = worldState.getState();
            const scenario = state.scenario;

            const completed = scenario.objectives.filter(obj => obj.completed).length;
            const total = scenario.objectives.length;
            const progress = (completed / total) * 100;

            const phaseColors = {
                orientation: 'orientation',
                investigation: 'investigation',
                resolution: 'resolution',
                aftermath: 'aftermath',
            };

            const phaseIcons = {
                orientation: '',
                investigation: '',
                resolution: '',
                aftermath: '',
            };

            container.innerHTML = `
                <div class="section-header">
                    <h3 class="section-title">Mission Objectives</h3>
                    <span class="section-badge">${completed}/${total}</span>
                </div>
                <div class="objectives-container">
                    <div class="progress-container">
                        <div class="progress-label">
                            <span>Progress</span>
                            <span>${completed}/${total} Complete</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>

                    <div class="phase-info">
                        <div class="phase-badge ${phaseColors[scenario.phase]}">
                            ${phaseIcons[scenario.phase]} ${scenario.phase.toUpperCase()}
                        </div>
                        <div class="time-display">
                             Time: ${formatTime(scenario.timeElapsed)}
                        </div>
                    </div>

                    <ul class="objectives-list">
                        ${scenario.objectives.map((obj, index) => `
                            <li class="objective-item ${obj.completed ? 'completed' : ''}">
                                <div class="objective-checkbox">
                                    ${obj.completed ? '' : ''}
                                </div>
                                <div class="objective-text">
                                    ${index + 1}. ${obj.text}
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                </div>
            `;
        }

        // Component: CodeEditor
        function renderCodeEditor() {
            const container = document.getElementById('code-editor');
            if (!container) return;

            const state = worldState.getState();
            const code = state.ui.codeEditorContent || initialCode;
            const hasChanges = code !== initialCode;
            const lines = code.split('\n');

            container.innerHTML = `
                <div class="code-editor-container">
                    <div class="code-editor-header">
                        <div class="file-tab">
                            <span class="file-icon"></span>
                            <span class="file-name">payments/utils.py</span>
                            ${hasChanges ? '<span class="file-modified"></span>' : ''}
                        </div>
                        <button class="run-tests-button" id="run-tests-btn" ${!hasChanges ? 'disabled' : ''}>
                             Run Tests
                        </button>
                    </div>
                    <div class="code-editor-body">
                        <div class="line-numbers">
                            ${lines.map((_, i) => `<div class="line-number">${i + 1}</div>`).join('')}
                        </div>
                        <textarea class="code-textarea" id="code-textarea" spellcheck="false">${code}</textarea>
                    </div>
                </div>
            `;

            // Add event listeners
            const textarea = document.getElementById('code-textarea');
            const runBtn = document.getElementById('run-tests-btn');

            textarea.addEventListener('input', (e) => {
                const newCode = e.target.value;
                worldState.updateState({
                    ui: { codeEditorContent: newCode },
                    scenario: {
                        codebase: {
                            hasChanges: newCode !== initialCode,
                        },
                    },
                });

                eventBus.publish(EventTypes.USER_CODE_CHANGE, {
                    code: newCode,
                    hasChanges: newCode !== initialCode,
                    timestamp: Date.now(),
                }, 'user');

                renderCodeEditor();
            });

            if (runBtn) {
                runBtn.addEventListener('click', () => {
                    const code = worldState.getState().ui.codeEditorContent;
                    const testsPass = code.includes('amount <= 0') && code.includes('raise');

                    eventBus.publish(EventTypes.USER_RUN_TESTS, {
                        code,
                        timestamp: Date.now(),
                    }, 'user');

                    setTimeout(() => {
                        if (testsPass) {
                            eventBus.publish(EventTypes.TESTS_PASSED, {
                                code,
                                testCount: 12,
                            }, 'system');

                            worldState.completeObjective('obj_2');
                            worldState.completeObjective('obj_3');
                        } else {
                            const failedTests = [];
                            if (!code.includes('amount <= 0')) {
                                failedTests.push({
                                    test: 'zero_amount_rejected',
                                    error: 'AssertionError: Expected ValueError for amount=0',
                                });
                            }
                            if (!code.includes('raise')) {
                                failedTests.push({
                                    test: 'invalid_amount_raises_error',
                                    error: 'AssertionError: No exception raised for invalid amount',
                                });
                            }

                            eventBus.publish(EventTypes.TESTS_FAILED, {
                                code,
                                failedTests,
                            }, 'system');
                        }
                    }, 1500);
                });
            }
        }

        // Component: TerminalOutput
        let terminalOutputLines = [];

        function renderTerminalOutput() {
            const container = document.getElementById('terminal-output');
            if (!container) return;

            container.innerHTML = `
                <div class="terminal-container">
                    <div class="terminal-header">
                        <div class="terminal-dots">
                            <span class="dot dot-red"></span>
                            <span class="dot dot-yellow"></span>
                            <span class="dot dot-green"></span>
                        </div>
                        <span class="terminal-title">Test Output</span>
                        <button class="terminal-clear" id="terminal-clear-btn">Clear</button>
                    </div>
                    <div class="terminal-body" id="terminal-body">
                        ${terminalOutputLines.length === 0 ? `
                            <div class="terminal-empty">
                                <span class="empty-icon" style="font-size: 48px; opacity: 0.5;"></span>
                                <p>Run tests to see output here</p>
                            </div>
                        ` : terminalOutputLines.map(line => `
                            <div class="terminal-line ${line.className}">${line.text || '&nbsp;'}</div>
                        `).join('')}
                    </div>
                </div>
            `;

            const clearBtn = document.getElementById('terminal-clear-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    terminalOutputLines = [];
                    renderTerminalOutput();
                });
            }

            // Auto-scroll
            const body = document.getElementById('terminal-body');
            if (body) {
                body.scrollTop = body.scrollHeight;
            }
        }

        function addTerminalLine(text, className = 'terminal-info') {
            terminalOutputLines.push({ text, className });
            renderTerminalOutput();
        }

        // Subscribe to test events
        eventBus.subscribe(EventTypes.USER_RUN_TESTS, () => {
            addTerminalLine('$ pytest tests/payments/test_process_payment.py', 'terminal-command');
            addTerminalLine('Collecting tests...', 'terminal-info');
        });

        eventBus.subscribe(EventTypes.TESTS_PASSED, (event) => {
            addTerminalLine('', 'terminal-blank');
            addTerminalLine('test_positive_amount_succeeds ', 'terminal-success');
            addTerminalLine('test_zero_amount_rejected ', 'terminal-success');
            addTerminalLine('test_negative_amount_rejected ', 'terminal-success');
            addTerminalLine('test_returns_success_message ', 'terminal-success');
            addTerminalLine('test_raises_validation_error ', 'terminal-success');
            addTerminalLine('', 'terminal-blank');
            addTerminalLine(`==================== ${event.payload.testCount} passed in 0.42s ====================`, 'terminal-success');
            addTerminalLine('', 'terminal-blank');
            addTerminalLine(' All tests passed!', 'terminal-success-bold');
        });

        eventBus.subscribe(EventTypes.TESTS_FAILED, (event) => {
            addTerminalLine('', 'terminal-blank');
            addTerminalLine('test_positive_amount_succeeds ', 'terminal-success');

            event.payload.failedTests.forEach(failure => {
                addTerminalLine(`test_${failure.test} `, 'terminal-error');
                addTerminalLine(`  ${failure.error}`, 'terminal-error-detail');
            });

            addTerminalLine('', 'terminal-blank');
            addTerminalLine(`==================== ${event.payload.failedTests.length} failed ====================`, 'terminal-error');
            addTerminalLine('', 'terminal-blank');
            addTerminalLine(' Some tests failed. Review the errors above.', 'terminal-error-bold');
        });

        // Component: AgentMessages - FIXED to only append new messages
        function renderAgentMessages() {
            const container = document.getElementById('agent-messages');
            if (!container) return;

            const state = worldState.getState();
            const messages = state.ui.messages;

            const agentAvatars = {
                senior_dev: '',
                pm: '',
                junior_dev: '',
                incident: '',
                user: '',
            };

            const agentNames = {
                senior_dev: 'Marcus (Senior Engineer)',
                pm: 'Sarah (Product Manager)',
                junior_dev: 'Alex (Junior Developer)',
                incident: 'Incident Monitor',
                user: 'You',
            };

            // Only render if container doesn't exist or if there are new messages
            const body = document.getElementById('messages-body');
            if (!body) {
                // Initial render
                container.innerHTML = `
                    <div class="messages-container">
                        <div class="section-header">
                            <h3 class="section-title">Team Messages</h3>
                            <span class="section-badge" id="message-count">${messages.length}</span>
                        </div>
                        <div class="messages-body" id="messages-body"></div>
                    </div>
                `;
                lastRenderedMessageCount = 0;
            }

            // Append only new messages
            const messagesBody = document.getElementById('messages-body');
            const messageCount = document.getElementById('message-count');

            if (messagesBody && messages.length > lastRenderedMessageCount) {
                const newMessages = messages.slice(lastRenderedMessageCount);

                newMessages.forEach(msg => {
                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${msg.type || 'response'}`;
                    messageEl.innerHTML = `
                        <div class="message-header">
                            <span class="agent-avatar">${agentAvatars[msg.agentId] || ''}</span>
                            <span class="agent-name">${agentNames[msg.agentId] || msg.agentRole}</span>
                            <span class="message-timestamp">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                        </div>
                        <div class="message-content">${msg.content}</div>
                    `;
                    messagesBody.appendChild(messageEl);
                });

                // Update count
                if (messageCount) {
                    messageCount.textContent = messages.length;
                }

                // Auto-scroll to latest
                messagesBody.scrollTop = messagesBody.scrollHeight;

                lastRenderedMessageCount = messages.length;
            }
        }

        // Component: ChatInput
        function renderChatInput() {
            const container = document.getElementById('chat-input');
            if (!container) return;

            const state = worldState.getState();
            const typing = state.ui.userTyping;
            const preview = state.ui.typingPreview;

            container.innerHTML = `
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        ${typing ? `
                            <div class="typing-preview">
                                ${preview}<span class="typing-cursor"></span>
                            </div>
                        ` : `
                            <div class="typing-preview" style="color: rgba(255, 255, 255, 0.4);">
                                Ask the team a question...
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // Component: TooltipGuide - Fixed to prevent flickering
        function renderTooltipGuide() {
            const container = document.getElementById('tooltip-guide');
            if (!container) return;

            const narration = guideController.getCurrentNarration();

            // Check if narration has actually changed
            const narrationKey = narration ? JSON.stringify(narration) : null;
            if (narrationKey === lastRenderedNarration) {
                return; // No change, skip re-render
            }
            lastRenderedNarration = narrationKey;

            if (!narration) {
                container.innerHTML = '';
                return;
            }

            const positions = {
                'top-center': 'top: 100px; left: 50%; transform: translateX(-50%);',
                'center': 'top: 50%; left: 50%; transform: translate(-50%, -50%);',
                'left': 'top: 50%; left: 80px; transform: translateY(-50%);',
                'right': 'top: 50%; right: 80px; transform: translateY(-50%);',
                'bottom': 'bottom: 100px; left: 50%; transform: translateX(-50%);',
            };

            const positionStyle = positions[narration.position] || positions['center'];

            container.innerHTML = `
                <div class="tooltip-guide" style="${positionStyle}">
                    <div class="tooltip-agent-header">
                        <span class="tooltip-agent-icon">${narration.agentIcon || ''}</span>
                        <span class="tooltip-agent-name">${narration.agent}</span>
                    </div>
                    ${narration.title ? `<div class="tooltip-title">${narration.title}</div>` : ''}
                    <div class="tooltip-description">${narration.description}</div>
                    ${narration.highlight ? `<div class="tooltip-highlight">${narration.highlight}</div>` : ''}
                </div>
            `;
        }

        // Subscribe to guide controller
        guideController.subscribe(() => {
            renderTooltipGuide();
        });

        // Main render function
        function renderApp() {
            renderObjectivesPanel();
            renderCodeEditor();
            renderTerminalOutput();
            renderAgentMessages(); // Now only appends new messages
            renderChatInput();
            // renderTooltipGuide is handled by guideController.subscribe() - removed to prevent flickering
        }

        // Subscribe to state changes
        worldState.subscribe(() => {
            renderApp();
        });

        // Subscribe to scenario complete
        eventBus.subscribe(EventTypes.SCENARIO_COMPLETE, () => {
            showCompletionOverlay();
        });

        function showCompletionOverlay() {
            const state = worldState.getState();
            const root = document.getElementById('root');

            const overlay = document.createElement('div');
            overlay.className = 'completion-overlay';
            overlay.innerHTML = `
                <div class="completion-content">
                    <h2> Scenario Complete!</h2>
                    <p>You've successfully completed the Payment API debugging challenge.</p>
                    <div class="completion-stats">
                        <div class="stat">
                            <span class="stat-label">Time</span>
                            <span class="stat-value">${Math.floor(state.scenario.timeElapsed / 60)}m</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Tasks</span>
                            <span class="stat-value">${state.scenario.objectives.length}/${state.scenario.objectives.length}</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Rating</span>
                            <span class="stat-value"></span>
                        </div>
                    </div>
                    <button class="btn-primary btn-large" onclick="handleRestart()">Try Another Scenario</button>
                </div>
            `;

            root.appendChild(overlay);
        }

        // Initialize the app
        function initializeApp() {
            const root = document.getElementById('root');

            root.innerHTML = `
                <div class="interactive-app">
                    <header class="app-header">
                        <div class="header-left">
                            <span class="app-logo"></span>
                            <div class="app-title-group">
                                <h1 class="app-title">
                                    SimuWork <span class="live-badge"><span class="live-dot"></span>LIVE</span>
                                </h1>
                                <p class="app-subtitle">AI-Powered Job Simulation Platform</p>
                            </div>
                        </div>
                        <div class="header-right">
                            <button class="btn-primary btn-large" id="start-demo-btn"> Start Demo</button>
                            <div class="status-indicator">
                                <span class="status-dot"></span>
                                Agents Active
                            </div>
                        </div>
                    </header>

                    <main class="app-main">
                        <div class="left-column">
                            <section class="section objectives-section" id="objectives-panel"></section>
                            <section class="section terminal-section" id="terminal-output"></section>
                        </div>

                        <div class="center-column">
                            <section class="section code-section" id="code-editor"></section>
                        </div>

                        <div class="right-column">
                            <section class="section messages-section" id="agent-messages"></section>
                        </div>
                    </main>

                    <div id="tooltip-guide"></div>
                    <div id="chat-input"></div>

                    <footer class="app-footer">
                        <p class="footer-text"> This is a living simulation - AI agents are responding in real-time</p>
                    </footer>
                </div>
            `;

            // Initialize systems
            console.log('Initializing SimuWork Platform...');
            agentOrchestrator.initialize();

            // Render initial state
            renderApp();

            // Add event listener to start button
            const startBtn = document.getElementById('start-demo-btn');
            if (startBtn) {
                startBtn.addEventListener('click', handleStartDemo);
            }
        }

        function handleStartDemo() {
            const startBtn = document.getElementById('start-demo-btn');
            if (startBtn) {
                startBtn.outerHTML = '<button class="btn-secondary" onclick="handleRestart()"> Restart</button>';
            }
            demoController.start();
        }

        function handleRestart() {
            // Remove completion overlay if exists
            const overlay = document.querySelector('.completion-overlay');
            if (overlay) {
                overlay.remove();
            }

            demoController.stop();
            guideController.reset();
            agentOrchestrator.restart();
            terminalOutputLines = [];
            lastRenderedMessageCount = 0; // Reset message counter
            lastRenderedNarration = null; // Reset narration tracker
            renderApp();

            // Reset button
            const headerRight = document.querySelector('.header-right');
            if (headerRight) {
                const btnContainer = headerRight.querySelector('button, .btn-secondary');
                if (btnContainer) {
                    btnContainer.outerHTML = '<button class="btn-primary btn-large" id="start-demo-btn"> Start Demo</button>';
                    document.getElementById('start-demo-btn').addEventListener('click', handleStartDemo);
                }
            }
        }

        // Start the application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
